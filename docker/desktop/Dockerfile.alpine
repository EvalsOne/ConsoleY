# 基础镜像
FROM alpine:3.19

# 设置环境变量
ENV DEBIAN_FRONTEND=noninteractive \
    LANG=en_US.UTF-8 \
    LANGUAGE=en_US:en \
    LC_ALL=en_US.UTF-8 \
    APP_NAME="ConsoleY" \
    APP_VERSION="1.0.0" \
    USERNAME=consoley \
    HOME=/home/consoley \
    DISPLAY_NUM=1 \
    HEIGHT=768 \
    WIDTH=1024 \
    DISPLAY=:1

# 第一阶段：安装基础系统包
RUN apk add --no-cache \
    # 系统工具
    sudo \
    curl \
    wget \
    git \
    ca-certificates \
    bash \
    # UI 相关
    xvfb \
    xterm \
    xdotool \
    imagemagick \
    x11vnc \
    # 开发工具
    build-base \
    pkgconfig \
    openssl-dev \
    # 网络工具
    net-tools \
    netcat-openbsd \
    # 桌面环境
    firefox-esr \
    xfce4-terminal \
    pcmanfm \
    dbus \
    gtk+2.0 \
    gtk+3.0 \
    ttf-liberation \
    supervisor

# 设置noVNC
RUN git clone --branch v1.5.0 https://github.com/novnc/noVNC.git /opt/noVNC && \
    git clone --branch v0.12.0 https://github.com/novnc/websockify /opt/noVNC/utils/websockify && \
    ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html

# 设置用户和权限
RUN adduser -D -h $HOME $USERNAME && \
    echo "${USERNAME} ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers && \
    # 创建必要的目录
    mkdir -p $HOME/.vnc \
            $HOME/.config \
            $HOME/Desktop \
            $HOME/Documents \
            $HOME/Downloads \
            $HOME/.config/pcmanfm/default \
            /tmp/.X11-unix \
            /var/log/supervisor && \
    # 设置VNC密码
    echo "consoley" | x11vnc -storepasswd -passfile $HOME/.vnc/passwd && \
    # 设置权限
    chmod 600 $HOME/.vnc/passwd && \
    chmod 1777 /tmp/.X11-unix && \
    chown -R $USERNAME:$USERNAME $HOME && \
    chown -R $USERNAME:$USERNAME /var/log/supervisor

# 安装Rust开发环境
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sudo -u $USERNAME sh -s -- -y && \
    echo 'source $HOME/.cargo/env' >> $HOME/.bashrc && \
    sudo -u $USERNAME bash -c 'source $HOME/.cargo/env && cargo install cargo-watch'

# 复制配置文件
COPY supervisord.dev.conf /etc/supervisor/conf.d/supervisord.conf
COPY startup.dev.sh /startup.dev.sh
COPY desktop-config/ /home/consoley/.config/
COPY image/.config/tint2/tint2rc /home/consoley/.config/tint2/

# 创建工作目录
WORKDIR /app/api-server

# 设置卷挂载点
VOLUME ["/app/api-server"]

# 设置权限
RUN chmod +x /startup.dev.sh && \
    chown $USERNAME:$USERNAME /startup.dev.sh

# 切换到非root用户
USER $USERNAME

# 暴露端口
EXPOSE 5900 6080 8080

# 启动命令
CMD ["/startup.dev.sh"] 